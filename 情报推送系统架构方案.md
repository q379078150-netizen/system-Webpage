# 情报推送系统架构方案

## 一、项目概述

### 1.1 核心需求
- **实时快讯系统**: 4-5星级情报秒级推送至全渠道（Ghost官网、Telegram Bot、Discord Webhook）
- **精华汇总系统**: 3星以上情报自动生成每日深度简报，发布到 insight.ai 首页
- **跨平台适配**: 多平台排版美化自适应
- **安全隔离**: 多渠道推送账号的安全隔离机制

### 1.2 技术栈选择

#### 后端技术栈
- **框架**: Flask (Python) - 轻量级，快速开发
- **任务调度**: APScheduler - 定时任务和实时推送
- **Ghost API**: Ghost Content API - 内容发布
- **Telegram Bot**: python-telegram-bot - Telegram推送
- **Discord**: discord.py 或 requests - Webhook推送
- **数据库**: PostgreSQL/SQLite - 情报存储和状态管理
- **消息队列**: Redis + Celery（可选，用于高并发）

#### 前端技术栈
- **Ghost CMS**: 使用Ghost原生主题系统
- **自定义页面**: Ghost的Custom Page功能
- **API集成**: Ghost Admin API + Content API

#### 部署方案
- **Ghost**: 独立部署或使用Ghost托管服务
- **推送服务**: 独立Flask服务，通过API与Ghost通信
- **容器化**: Docker + Docker Compose（推荐）

---

## 二、系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                   情报输入源                              │
│  (API/Webhook/爬虫/手动录入)                              │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│              情报处理中心 (Flask Service)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 分级系统  │  │ 内容处理  │  │ 推送调度  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 数据库   │  │ 消息队列  │  │ 日志系统  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────┬───────────┬───────────┬───────────┬──────────────┘
      │           │           │           │
      ▼           ▼           ▼           ▼
┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│  Ghost  │ │Telegram  │ │ Discord  │ │insight.ai│
│  官网   │ │   Bot    │ │ Webhook  │ │  首页    │
└─────────┘ └──────────┘ └──────────┘ └──────────┘
```

### 2.2 核心模块设计

#### 1. 情报分级模块 (IntelligenceClassifier)
- **功能**: 自动或手动对情报进行星级评定（1-5星）
- **规则**: 
  - 5星: 极高价值，秒级推送
  - 4星: 高价值，秒级推送
  - 3星: 中等价值，纳入每日简报
  - 2星: 低价值，仅存储
  - 1星: 无效情报，过滤

#### 2. 实时推送模块 (RealTimePublisher)
- **功能**: 4-5星情报秒级推送
- **渠道**:
  - Ghost官网（通过Ghost Admin API发布文章）
  - Telegram Bot（发送消息到指定频道/群组）
  - Discord Webhook（发送消息到指定频道）

#### 3. 内容格式化模块 (ContentFormatter)
- **功能**: 跨平台内容排版美化
- **适配**:
  - Ghost: Markdown格式，支持Ghost原生样式
  - Telegram: HTML/Markdown格式，支持Telegram样式
  - Discord: Markdown格式，支持Discord样式
  - 自动转换和优化

#### 4. 每日简报生成模块 (DailyDigestGenerator)
- **功能**: 自动生成每日深度简报
- **触发**: 每日固定时间（如00:00 UTC）
- **内容**: 汇总当日所有3星以上情报
- **发布**: 自动发布到 insight.ai 首页（通过Ghost API）

#### 5. 安全隔离模块 (SecurityIsolation)
- **功能**: 多渠道账号安全隔离
- **机制**:
  - 独立的API密钥管理
  - 环境变量隔离
  - 权限最小化原则
  - 操作日志记录

---

## 三、项目目录结构

```
intelligence_push_system/
├── app.py                      # Flask应用入口
├── config.py                   # 配置文件
├── requirements.txt             # Python依赖
├── .env.example                # 环境变量示例
├── README.md                   # 项目说明
│
├── backend/                    # 后端核心代码
│   ├── __init__.py
│   ├── routes.py              # API路由
│   ├── models.py              # 数据模型
│   ├── database.py            # 数据库操作
│   │
│   ├── intelligence/          # 情报处理模块
│   │   ├── __init__.py
│   │   ├── classifier.py     # 情报分级
│   │   ├── processor.py      # 内容处理
│   │   └── validator.py      # 数据验证
│   │
│   ├── publishers/            # 推送模块
│   │   ├── __init__.py
│   │   ├── base.py           # 基础推送类
│   │   ├── ghost.py          # Ghost推送
│   │   ├── telegram.py       # Telegram推送
│   │   ├── discord.py        # Discord推送
│   │   └── formatter.py      # 内容格式化
│   │
│   ├── digest/               # 简报生成模块
│   │   ├── __init__.py
│   │   ├── generator.py      # 简报生成器
│   │   └── template.py       # 简报模板
│   │
│   ├── scheduler/            # 任务调度
│   │   ├── __init__.py
│   │   └── tasks.py         # 定时任务
│   │
│   └── security/             # 安全模块
│       ├── __init__.py
│       ├── auth.py          # 认证授权
│       └── isolation.py     # 安全隔离
│
├── database/                  # 数据库
│   ├── migrations/           # 数据库迁移
│   └── init.sql              # 初始化脚本
│
├── logs/                     # 日志文件
│   └── app.log
│
├── templates/                # 模板文件
│   ├── digest_template.html # 简报HTML模板
│   └── notification_template.md # 推送消息模板
│
└── tests/                    # 测试文件
    ├── test_classifier.py
    ├── test_publishers.py
    └── test_digest.py
```

---

## 四、数据库设计

### 4.1 数据表结构

#### intelligence表（情报主表）
```sql
CREATE TABLE intelligence (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    source VARCHAR(200),
    rating INTEGER CHECK (rating BETWEEN 1 AND 5),
    status VARCHAR(50) DEFAULT 'pending', -- pending, published, archived
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);
```

#### push_log表（推送日志）
```sql
CREATE TABLE push_log (
    id SERIAL PRIMARY KEY,
    intelligence_id INTEGER REFERENCES intelligence(id),
    channel VARCHAR(50) NOT NULL, -- ghost, telegram, discord
    status VARCHAR(50) NOT NULL, -- success, failed, pending
    message TEXT,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### daily_digest表（每日简报）
```sql
CREATE TABLE daily_digest (
    id SERIAL PRIMARY KEY,
    date DATE UNIQUE NOT NULL,
    content TEXT NOT NULL,
    ghost_post_id VARCHAR(200),
    status VARCHAR(50) DEFAULT 'draft', -- draft, published
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);
```

---

## 五、核心功能实现

### 5.1 情报分级系统

```python
class IntelligenceClassifier:
    """情报分级系统"""
    
    def classify(self, intelligence):
        """
        对情报进行分级
        返回: 1-5星评级
        """
        # 基于关键词、来源、内容长度等因素自动分级
        # 也可以支持手动分级
        pass
```

### 5.2 实时推送系统

```python
class RealTimePublisher:
    """实时推送系统"""
    
    def publish_4_5_star(self, intelligence):
        """
        4-5星情报秒级推送
        """
        # 并行推送到所有渠道
        # Ghost + Telegram + Discord
        pass
```

### 5.3 内容格式化系统

```python
class ContentFormatter:
    """跨平台内容格式化"""
    
    def format_for_ghost(self, content):
        """Ghost格式（Markdown）"""
        pass
    
    def format_for_telegram(self, content):
        """Telegram格式（HTML/Markdown）"""
        pass
    
    def format_for_discord(self, content):
        """Discord格式（Markdown）"""
        pass
```

### 5.4 每日简报生成

```python
class DailyDigestGenerator:
    """每日简报生成器"""
    
    def generate_digest(self, date):
        """
        生成指定日期的简报
        汇总所有3星以上情报
        """
        pass
    
    def publish_to_ghost(self, digest):
        """发布到Ghost首页"""
        pass
```

---

## 六、API接口设计

### 6.1 情报管理API

```
POST /api/intelligence          # 创建新情报
GET  /api/intelligence          # 获取情报列表
GET  /api/intelligence/<id>     # 获取单个情报
PUT  /api/intelligence/<id>     # 更新情报
DELETE /api/intelligence/<id>   # 删除情报
POST /api/intelligence/<id>/classify  # 手动分级
```

### 6.2 推送管理API

```
POST /api/push/<intelligence_id>  # 手动触发推送
GET  /api/push/logs              # 获取推送日志
```

### 6.3 简报管理API

```
GET  /api/digest                 # 获取简报列表
GET  /api/digest/<date>          # 获取指定日期简报
POST /api/digest/generate        # 手动生成简报
POST /api/digest/<date>/publish  # 发布简报
```

---

## 七、安全隔离方案

### 7.1 环境变量隔离

```bash
# .env文件
GHOST_URL=https://your-ghost-site.com
GHOST_ADMIN_API_KEY=your-admin-key
GHOST_CONTENT_API_KEY=your-content-key

TELEGRAM_BOT_TOKEN=your-telegram-token
TELEGRAM_CHAT_ID=your-chat-id

DISCORD_WEBHOOK_URL=your-discord-webhook-url

INSIGHT_AI_GHOST_URL=https://insight.ai
INSIGHT_AI_ADMIN_KEY=your-insight-key
```

### 7.2 权限最小化

- 每个渠道使用独立的API密钥
- 不同环境使用不同的密钥
- 定期轮换密钥
- 操作日志记录所有API调用

### 7.3 安全措施

- API请求加密（HTTPS）
- 请求签名验证
- 速率限制
- IP白名单（可选）

---

## 八、开发步骤

### 阶段一：基础架构（1-2天）
1. 创建项目结构
2. 配置Flask应用
3. 设计数据库模型
4. 实现基础API

### 阶段二：情报处理（2-3天）
1. 实现情报分级系统
2. 实现内容处理模块
3. 实现数据验证
4. 添加日志记录

### 阶段三：推送系统（3-4天）
1. 集成Ghost API
2. 集成Telegram Bot
3. 集成Discord Webhook
4. 实现内容格式化
5. 实现实时推送

### 阶段四：简报系统（2-3天）
1. 实现简报生成器
2. 设计简报模板
3. 实现自动发布
4. 添加定时任务

### 阶段五：安全优化（1-2天）
1. 实现安全隔离
2. 添加认证授权
3. 实现操作日志
4. 性能优化

### 阶段六：测试部署（2-3天）
1. 单元测试
2. 集成测试
3. 部署配置
4. 监控设置

---

## 九、关键技术点

### 9.1 Ghost API集成
- 使用Ghost Admin API发布文章
- 使用Ghost Content API读取内容
- 支持自定义页面和路由

### 9.2 Telegram Bot
- 使用python-telegram-bot库
- 支持Markdown和HTML格式
- 支持频道和群组推送

### 9.3 Discord Webhook
- 使用Discord Webhook API
- 支持嵌入消息（Embeds）
- 支持Markdown格式

### 9.4 内容格式化
- 统一的Markdown解析
- 平台特定的样式转换
- 自动优化和美化

---

## 十、监控和运维

1. **日志系统**: 记录所有操作和错误
2. **性能监控**: 监控API响应时间
3. **推送成功率**: 监控各渠道推送成功率
4. **告警机制**: 推送失败自动告警

---

## 下一步行动

1. ✅ 确认架构方案
2. ⏳ 创建项目结构
3. ⏳ 实现核心模块
4. ⏳ 集成各平台API
5. ⏳ 测试和部署
